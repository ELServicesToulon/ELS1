<script>
/**
 * =================================================================
 * MODULE JAVASCRIPT - ESPACE CLIENT (Version avec historique)
 * =================================================================
 */

document.addEventListener('DOMContentLoaded', () => {
    // --- Références aux éléments du DOM ---
    const indicateurChargement = document.getElementById('indicateur-chargement');
    const contenuReservationsFutures = document.getElementById('contenu-reservations-futures');
    const contenuReservationsPassees = document.getElementById('contenu-reservations-passees');
    const modale = document.getElementById('modale-modification');
    const contenuModale = document.getElementById('contenu-modale-wrapper');
    const btnFermerModale = document.getElementById('btn-fermer-modale');
    const formulaireConnexionClient = document.getElementById('formulaire-connexion-client');
    const emailConnexionInput = document.getElementById('email-connexion');
    const erreurConnexionDiv = document.getElementById('erreur-connexion');
    const filtreAnnee = document.getElementById('filtre-annee');
    const filtreMois = document.getElementById('filtre-mois');

    // --- Variables d'état ---
    let toutesLesReservationsClient = [];
    let sessionToken = '';
    let anneesFiltrePopulees = false;

    /**
     * Initialise l'espace client.
     */
    function initialiser() {
        gererAffichageInitial();
        if (btnFermerModale) btnFermerModale.addEventListener('click', () => modale?.classList.add('hidden'));
        if (formulaireConnexionClient) formulaireConnexionClient.addEventListener('submit', demanderLien);
        if (filtreAnnee) filtreAnnee.addEventListener('change', () => chargerReservationsClient());
        if (filtreMois) filtreMois.addEventListener('change', () => chargerReservationsClient());
    }

    function demanderLien(e) { /* ... (inchangé) ... */ }

    function gererAffichageInitial() {
        const params = new URLSearchParams(window.location.search);
        const token = params.get('token');
        if (token) {
            sessionToken = token;
            verifierToken(token);
        } else {
            document.getElementById('conteneur-app')?.classList.add('hidden');
            document.getElementById('non-connecte')?.classList.remove('hidden');
            basculerIndicateurChargement(false);
        }
    }

    function verifierToken(token) {
        basculerIndicateurChargement(true);
        google.script.run
            .withSuccessHandler(reponse => {
                if (reponse.success && reponse.client) {
                    document.getElementById('message-bienvenue-client').textContent = `Bienvenue, ${reponse.client.nom}`;
                    document.getElementById('conteneur-app').classList.remove('hidden');
                    document.getElementById('non-connecte').classList.add('hidden');
                    chargerReservationsClient();
                } else {
                    sessionToken = '';
                    document.getElementById('conteneur-app').classList.add('hidden');
                    document.getElementById('non-connecte').classList.remove('hidden');
                    afficherErreurConnexion(reponse.error || "Lien invalide ou expiré.");
                    basculerIndicateurChargement(false);
                }
            })
            .withFailureHandler(err => {
                sessionToken = '';
                document.getElementById('conteneur-app').classList.add('hidden');
                document.getElementById('non-connecte').classList.remove('hidden');
                afficherErreurConnexion("Erreur de communication avec le serveur.");
                basculerIndicateurChargement(false);
            })
            .verifierTokenEtChargerDonnees(token);
    }

    /**
     * Charge les réservations en appliquant les filtres.
     */
    function chargerReservationsClient() {
        if (!sessionToken) return;
        basculerIndicateurChargement(true);

        const options = {
            annee: parseInt(filtreAnnee?.value, 10),
            mois: parseInt(filtreMois?.value, 10)
        };

        google.script.run
            .withSuccessHandler(reponse => {
                basculerIndicateurChargement(false);
                if (reponse.success) {
                    if (!anneesFiltrePopulees) {
                        toutesLesReservationsClient = [...reponse.futures, ...reponse.passees];
                        populerFiltreAnnees(toutesLesReservationsClient);
                        anneesFiltrePopulees = true;
                    }
                    afficherReservationsFutures(reponse.futures);
                    afficherReservationsPassees(reponse.passees);
                } else {
                    afficherErreur(reponse.error);
                }
            })
            .withFailureHandler(err => {
                basculerIndicateurChargement(false);
                afficherErreur(err.message);
            })
            .obtenirReservationsClient(sessionToken, options);
    }

    function afficherReservationsFutures(reservations) { /* ... (inchangé) ... */ }

    /**
     * Affiche les réservations passées avec filtres et bouton de téléchargement.
     */
    function afficherReservationsPassees(reservations) {
        if (!contenuReservationsPassees) return;
        contenuReservationsPassees.innerHTML = '';

        if (reservations.length === 0) {
            contenuReservationsPassees.innerHTML = '<p class="message-aucune-reservation">Aucune course terminée pour cette période.</p>';
            return;
        }

        reservations.forEach(resa => {
            const dateDebut = new Date(resa.start);
            const dateFormatee = dateDebut.toLocaleDateString('fr-FR', { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' });

            const btnTelecharger = resa.idPdf
                ? `<button class="btn btn-primaire btn-telecharger-facture" data-id-pdf="${resa.idPdf}">Facture</button>`
                : `<button class="btn btn-secondaire" disabled title="Facture non disponible">Facture</button>`;

            const resaHtml = `
                <div class="reservation-item reservation-item-passee" data-id="${resa.id}">
                    <div class="reservation-details">
                        <h4>${dateFormatee}</h4>
                        <p><strong>Détails :</strong> ${resa.details}</p>
                        <p><strong>Facture n° :</strong> ${resa.numFacture || 'N/A'}</p>
                        <p><strong>Montant :</strong> ${resa.amount.toFixed(2)} €</p>
                    </div>
                    <div class="reservation-actions">
                        ${btnTelecharger}
                    </div>
                </div>
            `;
            contenuReservationsPassees.insertAdjacentHTML('beforeend', resaHtml);
        });

        attacherEcouteursTelechargement();
    }

    function attacherEcouteursTelechargement() {
        document.querySelectorAll('.btn-telecharger-facture').forEach(btn => {
            btn.addEventListener('click', e => {
                const idPdf = e.target.dataset.idPdf;
                telechargerFacture(idPdf, e.target);
            });
        });
    }

    function telechargerFacture(idPdf, button) {
        if (button) button.disabled = true;
        basculerIndicateurChargement(true);

        google.script.run
            .withSuccessHandler(reponse => {
                basculerIndicateurChargement(false);
                if (button) button.disabled = false;

                if (reponse.success) {
                    const link = document.createElement('a');
                    link.href = `data:${reponse.mimeType};base64,${reponse.data}`;
                    link.download = reponse.fileName;
                    document.body.appendChild(link);
                    link.click();
                    document.body.removeChild(link);
                } else {
                    afficherErreur(reponse.error);
                }
            })
            .withFailureHandler(err => {
                basculerIndicateurChargement(false);
                if (button) button.disabled = false;
                afficherErreur(err.message);
            })
            .obtenirBlobFactureBase64(sessionToken, idPdf);
    }

    function populerFiltreAnnees(reservations) {
        if (!filtreAnnee) return;
        const annees = [...new Set(reservations.map(r => new Date(r.start).getFullYear()))];
        annees.sort((a, b) => b - a); // Plus récentes en premier

        filtreAnnee.innerHTML = '<option value="0">Toutes les années</option>';
        annees.forEach(annee => {
            const option = document.createElement('option');
            option.value = annee;
            option.textContent = annee;
            filtreAnnee.appendChild(option);
        });
    }

    // --- Fonctions utilitaires (inchangées) ---
    function afficherErreurConnexion(message) { /* ... */ }
    function basculerIndicateurChargement(afficher) { /* ... */ }
    function afficherNotification(message, type = "succes") { /* ... */ }
    function afficherErreur(erreur) { /* ... */ }
    function gererModificationArrets(idReservation) { /* ... */ }
    function gererDeplacement(idReservation) { /* ... */ }
    function chargerCreneauxDeplacement(idReservation, dateString) { /* ... */ }
    function validerDeplacement(idReservation, nouvelleDate, nouvelleHeure) { /* ... */ }


    initialiser();
});
</script>
<script>
// --- Fonctions utilitaires (inchangées) ---
function afficherErreurConnexion(message) {
    const erreurConnexionDiv = document.getElementById('erreur-connexion');
    if (erreurConnexionDiv) {
        erreurConnexionDiv.textContent = message;
        erreurConnexionDiv.classList.remove('hidden');
    }
}

function basculerIndicateurChargement(afficher) {
    const indicateurChargement = document.getElementById('indicateur-chargement');
    if(indicateurChargement) indicateurChargement.classList.toggle('hidden', !afficher);
}

function afficherNotification(message, type = "succes") {
    const conteneur = document.getElementById('conteneur-notifications');
    if(!conteneur) return;
    const notif = document.createElement('div');
    notif.className = `notification ${type}`;
    notif.textContent = message;
    conteneur.appendChild(notif);
    setTimeout(() => notif.remove(), 5000);
}

function afficherErreur(erreur) {
    basculerIndicateurChargement(false);
    const message = typeof erreur === 'object' && erreur.message ? erreur.message : String(erreur);
    afficherNotification(`Erreur : ${message}`, "erreur");
    console.error(erreur);
}

function gererModificationArrets(idReservation) { /* ... */ }
function gererDeplacement(idReservation) { /* ... */ }
function chargerCreneauxDeplacement(idReservation, dateString) { /* ... */ }
function validerDeplacement(idReservation, nouvelleDate, nouvelleHeure) { /* ... */ }
</script>
<script>
// --- Fonctions de la modale de modification (déplacées pour la clarté) ---
function gererModificationArrets(idReservation) {
    const resa = toutesLesReservationsClient.find(r => r.id === idReservation);
    if (!resa) return;
    const arretsActuels = resa.arretsSupplementaires;
    const nouveauxArrets = arretsActuels + 1;
    if (!confirm(`Vous allez ajouter un arrêt supplémentaire. Le montant de la course sera recalculé. Continuer ?`)) return;
    basculerIndicateurChargement(true);
    google.script.run.withSuccessHandler(reponse => {
        if (reponse.success) {
            afficherNotification("Arrêt ajouté avec succès ! Le prix a été mis à jour.");
            chargerReservationsClient();
        } else {
            afficherErreur(reponse.error);
            basculerIndicateurChargement(false);
        }
    }).withFailureHandler(err => {
        afficherErreur(err.message);
        basculerIndicateurChargement(false);
    }).mettreAJourDetailsReservationClient(sessionToken, idReservation, nouveauxArrets);
}

function gererDeplacement(idReservation) {
    const resa = toutesLesReservationsClient.find(r => r.id === idReservation);
    const modale = document.getElementById('modale-modification');
    const contenuModale = document.getElementById('contenu-modale-wrapper');
    if (!resa || !contenuModale) return;
    contenuModale.innerHTML = `
        <h3 id="modale-modification-titre">Déplacer la course</h3>
        <p><strong>Course actuelle :</strong> ${new Date(resa.start).toLocaleString('fr-FR')}</p>
        <div class="groupe-formulaire">
            <label for="nouvelle-date">Nouvelle date :</label>
            <input type="date" id="nouvelle-date" class="champ-formulaire" min="${new Date().toISOString().split('T')[0]}">
        </div>
        <div class="groupe-formulaire">
            <label>Nouveau créneau :</label>
            <div id="grille-creneaux-deplacement" class="grille-creneaux"></div>
        </div>
    `;
    modale?.classList.remove('hidden');
    const inputDate = document.getElementById('nouvelle-date');
    inputDate.addEventListener('change', () => chargerCreneauxDeplacement(idReservation, inputDate.value));
}

function chargerCreneauxDeplacement(idReservation, dateString) {
    const resa = toutesLesReservationsClient.find(r => r.id === idReservation);
    const grille = document.getElementById('grille-creneaux-deplacement');
    if (!resa || !grille) return;
    const duree = (new Date(resa.end || resa.start) - new Date(resa.start)) / 60000;
    grille.innerHTML = '<div class="spinner"></div>';
    google.script.run.withSuccessHandler(creneaux => {
        grille.innerHTML = '';
        if (creneaux && creneaux.length > 0) {
            creneaux.forEach(heure => {
                const btn = document.createElement('button');
                btn.className = 'slot-btn';
                btn.textContent = heure;
                btn.onclick = () => validerDeplacement(idReservation, dateString, heure);
                grille.appendChild(btn);
            });
        } else {
            grille.innerHTML = '<p>Aucun créneau disponible.</p>';
        }
    }).withFailureHandler(err => afficherErreur(err.message)).obtenirCreneauxDisponiblesPourDate(dateString, duree, resa.eventId);
}

function validerDeplacement(idReservation, nouvelleDate, nouvelleHeure) {
    basculerIndicateurChargement(true);
    document.getElementById('modale-modification')?.classList.add('hidden');
    google.script.run.withSuccessHandler(reponse => {
        basculerIndicateurChargement(false);
        if (reponse.success) {
            afficherNotification("Réservation déplacée avec succès !");
            chargerReservationsClient();
        } else {
            afficherErreur(reponse.error);
        }
    }).withFailureHandler(err => {
        afficherErreur(err.message);
        basculerIndicateurChargement(false);
    }).replanifierReservationClient(sessionToken, idReservation, nouvelleDate, nouvelleHeure);
}
</script>
