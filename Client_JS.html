<script>
/**
 * =================================================================
 * MODULE JAVASCRIPT - ESPACE CLIENT (Version mise à jour)
 * =================================================================
 */

document.addEventListener('DOMContentLoaded', () => {
    // --- Références aux éléments du DOM ---
    const indicateurChargement = document.getElementById('indicateur-chargement');
    const contenuReservationsFutures = document.getElementById('contenu-reservations-futures');
    const contenuReservationsPassees = document.getElementById('contenu-reservations-passees');
    const modale = document.getElementById('modale-modification');
    const contenuModale = document.getElementById('contenu-modale-wrapper');
    const btnFermerModale = document.getElementById('btn-fermer-modale');
    const formulaireConnexionClient = document.getElementById('formulaire-connexion-client');
    const emailConnexionInput = document.getElementById('email-connexion');
    const erreurConnexionDiv = document.getElementById('erreur-connexion');

    // --- Variables d'état ---
    let toutesLesReservationsClient = [];
    let sessionToken = ''; // Pour stocker le token de session

    /**
     * Initialise l'espace client.
     */
    function initialiser() {
        gererAffichageInitial();
        if (btnFermerModale) btnFermerModale.addEventListener('click', () => modale?.classList.add('hidden'));
        if (formulaireConnexionClient) formulaireConnexionClient.addEventListener('submit', demanderLien);
    }

    /**
     * Gère la demande de lien de connexion.
     */
    function demanderLien(e) {
        e.preventDefault();
        const email = emailConnexionInput.value.trim();
        if (!email) return;

        basculerIndicateurChargement(true);
        erreurConnexionDiv.classList.add('hidden');
        const submitButton = formulaireConnexionClient.querySelector('button[type="submit"]');
        if(submitButton) submitButton.disabled = true;

        google.script.run
            .withSuccessHandler(reponse => {
                basculerIndicateurChargement(false);
                if (reponse.success) {
                    const parent = formulaireConnexionClient.parentNode;
                    formulaireConnexionClient.style.display = 'none';
                    const successMessageDiv = document.createElement('div');
                    successMessageDiv.className = 'message-succes-connexion';
                    successMessageDiv.innerHTML = `✅ ${reponse.message}<br><small>Veuillez consulter votre boîte de réception (et vos spams).</small>`;
                    parent.appendChild(successMessageDiv);
                } else {
                    afficherErreurConnexion(reponse.message || "Une erreur est survenue.");
                    if(submitButton) submitButton.disabled = false;
                }
            })
            .withFailureHandler(err => {
                basculerIndicateurChargement(false);
                afficherErreurConnexion("Une erreur de communication est survenue.");
                if(submitButton) submitButton.disabled = false;
            })
            .demanderLienDeConnexion(email);
    }

    /**
     * Gère l'affichage initial en fonction du token dans l'URL.
     */
    function gererAffichageInitial() {
        const params = new URLSearchParams(window.location.search);
        const token = params.get('token');
        
        if (token) {
            sessionToken = token; // Stocker le token
            verifierToken(token);
        } else {
            document.getElementById('conteneur-app')?.classList.add('hidden');
            document.getElementById('non-connecte')?.classList.remove('hidden');
            basculerIndicateurChargement(false);
        }
    }

    /**
     * Valide le jeton et charge les données du client.
     */
    function verifierToken(token) {
        basculerIndicateurChargement(true);
        google.script.run
            .withSuccessHandler(reponse => {
                if (reponse.success && reponse.client) {
                    document.getElementById('message-bienvenue-client').textContent = `Bienvenue, ${reponse.client.nom}`;
                    document.getElementById('conteneur-app').classList.remove('hidden');
                    document.getElementById('non-connecte').classList.add('hidden');
                    chargerReservationsClient(); // On utilise le token stocké pour charger les résas
                } else {
                    sessionToken = ''; // Invalider le token
                    document.getElementById('conteneur-app').classList.add('hidden');
                    document.getElementById('non-connecte').classList.remove('hidden');
                    afficherErreurConnexion(reponse.error || "Lien invalide ou expiré.");
                    basculerIndicateurChargement(false);
                }
            })
            .withFailureHandler(err => {
                sessionToken = ''; // Invalider le token
                document.getElementById('conteneur-app').classList.add('hidden');
                document.getElementById('non-connecte').classList.remove('hidden');
                afficherErreurConnexion("Erreur de communication avec le serveur.");
                basculerIndicateurChargement(false);
            })
            .verifierTokenEtChargerDonnees(token);
    }

    /**
     * Charge les réservations pour un client (identifié par son token).
     */
    function chargerReservationsClient() {
        if (!sessionToken) return;
        basculerIndicateurChargement(true);
        google.script.run
            .withSuccessHandler(reponse => {
                basculerIndicateurChargement(false);
                if (reponse.success) {
                    toutesLesReservationsClient = [...reponse.futures, ...reponse.passees];
                    afficherReservationsFutures(reponse.futures);
                    afficherReservationsPassees(reponse.passees);
                } else {
                    afficherErreur(reponse.error);
                }
            })
            .withFailureHandler(err => {
                basculerIndicateurChargement(false);
                afficherErreur(err.message);
            })
            .obtenirReservationsClient(sessionToken);
    }

    /**
     * Affiche les réservations futures (modifiables).
     */
    function afficherReservationsFutures(reservations) {
        if (!contenuReservationsFutures) return;
        contenuReservationsFutures.innerHTML = '';

        if (reservations.length === 0) {
            contenuReservationsFutures.innerHTML = '<p class="message-aucune-reservation">Vous n\'avez aucune course à venir.</p>';
            return;
        }

        reservations.sort((a, b) => new Date(a.start) - new Date(b.start));

        reservations.forEach(resa => {
            const dateDebut = new Date(resa.start);
            const dateFormatee = dateDebut.toLocaleDateString('fr-FR', { weekday: 'long', day: 'numeric', month: 'long' });
            const heureFormatee = dateDebut.toLocaleTimeString('fr-FR', { hour: '2-digit', minute: '2-digit' });
            const deplacementDesactive = resa.modifiable ? '' : 'disabled';
            const deplacementTooltip = resa.modifiable ? '' : 'title="Le délai pour déplacer cette course est dépassé."';

            const resaHtml = `
                <div class="reservation-item" data-id="${resa.id}">
                    <div class="reservation-details">
                        <h4>${dateFormatee} à ${heureFormatee}</h4>
                        <p><strong>Détails :</strong> ${resa.details}</p>
                        <p><strong>Montant :</strong> ${resa.amount.toFixed(2)} €</p>
                    </div>
                    <div class="reservation-actions">
                        <button class="btn btn-primaire btn-modifier-arrets">Ajouter un arrêt</button>
                        <button class="btn btn-secondaire btn-deplacer" ${deplacementDesactive} ${deplacementTooltip}>Déplacer</button>
                    </div>
                </div>
            `;
            contenuReservationsFutures.insertAdjacentHTML('beforeend', resaHtml);
        });

        document.querySelectorAll('.btn-modifier-arrets').forEach(btn => btn.addEventListener('click', (e) => gererModificationArrets(e.target.closest('.reservation-item').dataset.id)));
        document.querySelectorAll('.btn-deplacer').forEach(btn => btn.addEventListener('click', (e) => gererDeplacement(e.target.closest('.reservation-item').dataset.id)));
    }

    /**
     * Affiche les réservations passées (non modifiables).
     */
    function afficherReservationsPassees(reservations) {
        if (!contenuReservationsPassees) return;
        contenuReservationsPassees.innerHTML = '';

        if (reservations.length === 0) {
            contenuReservationsPassees.innerHTML = '<p class="message-aucune-reservation">Vous n\'avez aucune course terminée.</p>';
            return;
        }

        reservations.sort((a, b) => new Date(b.start) - new Date(a.start)); // Plus récentes en premier

        reservations.forEach(resa => {
            const dateDebut = new Date(resa.start);
            const dateFormatee = dateDebut.toLocaleDateString('fr-FR', { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' });
            const heureFormatee = dateDebut.toLocaleTimeString('fr-FR', { hour: '2-digit', minute: '2-digit' });

            const resaHtml = `
                <div class="reservation-item reservation-item-passee">
                    <div class="reservation-details">
                        <h4>${dateFormatee} à ${heureFormatee}</h4>
                        <p><strong>Détails :</strong> ${resa.details}</p>
                        <p><strong>Montant :</strong> ${resa.amount.toFixed(2)} €</p>
                    </div>
                </div>
            `;
            contenuReservationsPassees.insertAdjacentHTML('beforeend', resaHtml);
        });
    }

    /**
     * Gère l'ajout d'un arrêt.
     */
    function gererModificationArrets(idReservation) {
        const resa = toutesLesReservationsClient.find(r => r.id === idReservation);
        if (!resa) return;

        const arretsActuels = resa.arretsSupplementaires;
        const nouveauxArrets = arretsActuels + 1;

        if (!confirm(`Vous allez ajouter un arrêt supplémentaire. Le montant de la course sera recalculé. Continuer ?`)) {
            return;
        }

        basculerIndicateurChargement(true);
        google.script.run
            .withSuccessHandler(reponse => {
                if (reponse.success) {
                    afficherNotification("Arrêt ajouté avec succès ! Le prix a été mis à jour.");
                    chargerReservationsClient();
                } else {
                    afficherErreur(reponse.error);
                    basculerIndicateurChargement(false);
                }
            })
            .withFailureHandler(err => {
                afficherErreur(err.message);
                basculerIndicateurChargement(false);
            })
            .mettreAJourDetailsReservationClient(sessionToken, idReservation, nouveauxArrets);
    }

    /**
     * Gère l'ouverture de la modale pour déplacer une réservation.
     */
    function gererDeplacement(idReservation) {
        const resa = toutesLesReservationsClient.find(r => r.id === idReservation);
        if (!resa || !contenuModale) return;

        contenuModale.innerHTML = `
            <h3 id="modale-modification-titre">Déplacer la course</h3>
            <p><strong>Course actuelle :</strong> ${new Date(resa.start).toLocaleString('fr-FR')}</p>
            <div class="groupe-formulaire">
                <label for="nouvelle-date">Nouvelle date :</label>
                <input type="date" id="nouvelle-date" class="champ-formulaire" min="${new Date().toISOString().split('T')[0]}">
            </div>
            <div class="groupe-formulaire">
                <label>Nouveau créneau :</label>
                <div id="grille-creneaux-deplacement" class="grille-creneaux"></div>
            </div>
        `;
        modale?.classList.remove('hidden');

        const inputDate = document.getElementById('nouvelle-date');
        inputDate.addEventListener('change', () => chargerCreneauxDeplacement(idReservation, inputDate.value));
    }

    /**
     * Charge les créneaux disponibles pour un déplacement.
     */
    function chargerCreneauxDeplacement(idReservation, dateString) {
        const resa = toutesLesReservationsClient.find(r => r.id === idReservation);
        const grille = document.getElementById('grille-creneaux-deplacement');
        if (!resa || !grille) return;

        const duree = (new Date(resa.end || resa.start) - new Date(resa.start)) / 60000;
        grille.innerHTML = '<div class="spinner"></div>';
        
        google.script.run
            .withSuccessHandler(creneaux => {
                grille.innerHTML = '';
                if (creneaux && creneaux.length > 0) {
                    creneaux.forEach(heure => {
                        const btn = document.createElement('button');
                        btn.className = 'slot-btn';
                        btn.textContent = heure;
                        btn.onclick = () => validerDeplacement(idReservation, dateString, heure);
                        grille.appendChild(btn);
                    });
                } else {
                    grille.innerHTML = '<p>Aucun créneau disponible.</p>';
                }
            })
            .withFailureHandler(err => afficherErreur(err.message))
            .obtenirCreneauxDisponiblesPourDate(dateString, duree, resa.eventId);
    }

    /**
     * Valide et envoie le déplacement de la réservation.
     */
    function validerDeplacement(idReservation, nouvelleDate, nouvelleHeure) {
        basculerIndicateurChargement(true);
        modale?.classList.add('hidden');
        google.script.run
            .withSuccessHandler(reponse => {
                basculerIndicateurChargement(false);
                if (reponse.success) {
                    afficherNotification("Réservation déplacée avec succès !");
                    chargerReservationsClient();
                } else {
                    afficherErreur(reponse.error);
                }
            })
            .withFailureHandler(err => {
                afficherErreur(err.message);
                basculerIndicateurChargement(false);
            })
            .replanifierReservationClient(sessionToken, idReservation, nouvelleDate, nouvelleHeure);
    }

    // --- Fonctions utilitaires ---
    function afficherErreurConnexion(message) {
        if (erreurConnexionDiv) {
            erreurConnexionDiv.textContent = message;
            erreurConnexionDiv.classList.remove('hidden');
        }
    }
    
    function basculerIndicateurChargement(afficher) {
        if(indicateurChargement) indicateurChargement.classList.toggle('hidden', !afficher);
    }
    
    function afficherNotification(message, type = "succes") {
        const conteneur = document.getElementById('conteneur-notifications');
        if(!conteneur) return;
        const notif = document.createElement('div');
        notif.className = `notification ${type}`;
        notif.textContent = message;
        conteneur.appendChild(notif);
        setTimeout(() => notif.remove(), 5000);
    }
    
    function afficherErreur(erreur) {
        basculerIndicateurChargement(false);
        const message = typeof erreur === 'object' && erreur.message ? erreur.message : String(erreur);
        afficherNotification(`Erreur : ${message}`, "erreur");
        console.error(erreur);
    }

    initialiser();
});
</script>
