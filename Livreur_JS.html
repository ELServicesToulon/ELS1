<script>
document.addEventListener('DOMContentLoaded', () => {
    // --- Références DOM ---
    const champDate = document.getElementById('date-livraison');
    const filtreStatut = document.getElementById('filtre-statut');
    const triCourses = document.getElementById('tri-courses');
    const contenuReservations = document.getElementById('contenu-reservations');

    /**
     * Initialise la page et les écouteurs d'événements.
     */
    function initialiser() {
        const aujourdhui = new Date().toISOString().split('T')[0];
        if (champDate) {
            champDate.value = aujourdhui;
            // Un seul écouteur pour recharger les données
            [champDate, filtreStatut, triCourses].forEach(el => {
                el?.addEventListener('change', chargerReservations);
            });
        }
        chargerReservations(); // Charge initial
    }

    /**
     * Récupère les valeurs des contrôles et charge les réservations.
     */
    function chargerReservations() {
        const dateString = champDate?.value;
        if (!dateString) return;

        basculerIndicateurChargement(true);
        if (contenuReservations) contenuReservations.innerHTML = '<p>Chargement des courses...</p>';

        const options = {
            filtreStatut: filtreStatut?.value || 'tous',
            tri: triCourses?.value || 'heure_asc'
        };

        google.script.run
            .withSuccessHandler(reponse => {
                basculerIndicateurChargement(false);
                if (reponse.success) {
                    afficherReservations(reponse.reservations);
                } else {
                    afficherErreur(reponse.error);
                }
            })
            .withFailureHandler(afficherErreur)
            .getReservationsPourLivreur(dateString, options);
    }

    /**
     * Affiche les réservations dans le DOM.
     */
    function afficherReservations(reservations) {
        if (!contenuReservations) return;
        contenuReservations.innerHTML = '';
        if (!reservations || reservations.length === 0) {
            contenuReservations.innerHTML = '<div class="carte"><p>Aucune course ne correspond à vos critères pour cette date.</p></div>';
            return;
        }

        reservations.forEach(resa => {
            const resaElement = document.createElement('div');
            const statutClass = `statut-${(resa.statut || 'a-venir').toLowerCase().replace(/[\s_]+/g, '-')}`;
            resaElement.className = `carte reservation-item ${statutClass}`;
            resaElement.dataset.id = resa.id;
            resaElement.dataset.adresse = resa.destinationAddress;

            const heureDebut = new Date(resa.start).toLocaleTimeString('fr-FR', { hour: '2-digit', minute: '2-digit' });
            const statutHtml = resa.statut ? `<span class="statut-badge">${resa.statut}</span>` : '';

            // Déterminer le texte et le prochain statut pour le bouton d'action
            let actionTexte, prochainStatut;
            switch (resa.statut) {
                case 'En cours':
                    actionTexte = 'Marquer comme Livré';
                    prochainStatut = 'Livré';
                    break;
                case 'Livré':
                    actionTexte = 'Course Terminée';
                    prochainStatut = null; // Pas d'action
                    break;
                default: // 'À venir' ou statut vide
                    actionTexte = 'Prise en charge';
                    prochainStatut = 'En cours';
            }

            resaElement.innerHTML = `
                <h4>${heureDebut} - ${resa.clientName} ${statutHtml}</h4>
                <p><strong>Détails :</strong> ${resa.details}</p>
                <p><strong>Adresse :</strong> ${resa.destinationAddress || 'Non spécifiée'}</p>
                <div class="actions-livraison">
                    <button class="btn btn-secondaire btn-itineraire" ${!resa.destinationAddress ? 'disabled' : ''}>Itinéraire</button>
                    <button class="btn btn-primaire btn-statut" data-prochain-statut="${prochainStatut || ''}" ${!prochainStatut ? 'disabled' : ''}>${actionTexte}</button>
                </div>
            `;
            contenuReservations.appendChild(resaElement);
        });

        attacherEcouteursActions();
    }

    /**
     * Attache les écouteurs d'événements aux boutons d'action des réservations.
     */
    function attacherEcouteursActions() {
        document.querySelectorAll('.btn-statut').forEach(btn => {
            btn.addEventListener('click', (e) => {
                const itemDiv = e.target.closest('.reservation-item');
                const idReservation = itemDiv?.dataset.id;
                const prochainStatut = e.target.dataset.prochainStatut;
                if (idReservation && prochainStatut) {
                    marquerStatut(idReservation, prochainStatut, e.target);
                }
            });
        });

        document.querySelectorAll('.btn-itineraire').forEach(btn => {
            btn.addEventListener('click', (e) => {
                const itemDiv = e.target.closest('.reservation-item');
                const adresse = itemDiv?.dataset.adresse;
                if (adresse) {
                    const url = `https://www.google.com/maps/dir/?api=1&destination=${encodeURIComponent(adresse)}`;
                    window.open(url, '_blank');
                }
            });
        });
    }

    /**
     * Appelle le backend pour marquer le nouveau statut d'une course.
     */
    function marquerStatut(idReservation, statut, button) {
        basculerIndicateurChargement(true);
        if (button) button.disabled = true;

        google.script.run
            .withSuccessHandler(reponse => {
                basculerIndicateurChargement(false);
                if (reponse.success) {
                    afficherNotification(`Course marquée comme "${statut}"`, "succes");
                    chargerReservations(); // Recharger la liste pour refléter le changement
                } else {
                    if (button) button.disabled = false;
                    afficherErreur(reponse.error);
                }
            })
            .withFailureHandler(err => {
                if (button) button.disabled = false;
                afficherErreur(err);
            })
            .marquerStatutCourse(idReservation, statut);
    }

    // --- Fonctions utilitaires ---
    function basculerIndicateurChargement(afficher) {
        const indicateur = document.getElementById('indicateur-chargement');
        if (indicateur) indicateur.classList.toggle('hidden', !afficher);
    }

    function afficherNotification(message, type = "succes") {
        const conteneur = document.getElementById('conteneur-notifications');
        if (!conteneur) return;
        const notif = document.createElement('div');
        notif.className = `notification ${type}`;
        notif.textContent = message;
        conteneur.appendChild(notif);
        setTimeout(() => {
            notif.style.opacity = '0';
            setTimeout(() => notif.remove(), 500);
        }, 4000);
    }

    function afficherErreur(erreur) {
        basculerIndicateurChargement(false);
        const message = typeof erreur === 'object' && erreur.message ? erreur.message : String(erreur);
        afficherNotification(`Erreur : ${message}`, "erreur");
        console.error(erreur);
    }

    // --- Point de départ ---
    initialiser();
});
</script>
