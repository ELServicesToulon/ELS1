<script>
/**
 * =================================================================
 * MODULE JAVASCRIPT - PRINCIPAL
 * =================================================================
 * Description: Point d'entrée principal du script côté client.
 * Initialise l'état de l'application, configure les écouteurs
 * d'événements et lance l'affichage initial.
 */

// État global de l'application côté client
window.etat = {
  dateActuelle: new Date(),
  panier: [],
  tourneeEnCours: {}, // Sera peuplé lors de la configuration
  clientReconnu: null
};

/**
 * Configure tous les écouteurs d'événements de l'application.
 */
function configurerEcouteursEvenements() {
  const { ui } = window;

  // Gère les clics sur les jours du calendrier.
  ui.grilleCalendrier?.addEventListener('click', (e) => {
    const jourClique = e.target.closest('.jour-calendrier');
    if (jourClique && !jourClique.classList.contains('desactive')) {
      const dateString = jourClique.dataset.date;
      if(dateString) {
        ouvrirConfigurationTournee(dateString);
      }
    }
  });

  // Navigation du calendrier
  ui.btnMoisPrecedent?.addEventListener('click', () => changerMois(-1));
  ui.btnMoisSuivant?.addEventListener('click', () => changerMois(1));

  // Écouteur pour le formulaire de configuration de tournée
  ui.formulaireConfigTournee?.addEventListener('submit', gererDemandeCreneaux);

  // Actions de la modale de configuration (Modale 1)
  ui.btnFermerConfigTournee?.addEventListener('click', () => ui.modaleConfigTournee.classList.add('hidden'));
  ui.btnAjouterArret?.addEventListener('click', () => {
    ui.valeurArretsSup.textContent = parseInt(ui.valeurArretsSup.textContent) + 1;
    mettreAJourResumeTournee();
  });
  ui.btnRetirerArret?.addEventListener('click', () => {
    const valeur = parseInt(ui.valeurArretsSup.textContent);
    if (valeur > 1) {
      ui.valeurArretsSup.textContent = valeur - 1;
      mettreAJourResumeTournee();
    }
  });
  ui.interrupteurRetour?.addEventListener('change', mettreAJourResumeTournee);

  // Actions de la modale de sélection de créneau (Modale 2)
  ui.btnFermerSelectionCreneau?.addEventListener('click', () => ui.modaleSelectionCreneau.classList.add('hidden'));
  ui.btnAjouterAuPanier?.addEventListener('click', gererAjoutAuPanier);
  ui.btnModifierTournee?.addEventListener('click', retourVersConfiguration);

  // Écouteurs pour la modale de confirmation de récurrence (Modale 3)
  const modaleRecurrence = document.getElementById('modale-confirmation-recurrence');
  document.getElementById('btn-confirmer-recurrence')?.addEventListener('click', confirmerEtAjouterRecurrenceAuPanier);
  document.getElementById('btn-fermer-confirmation-recurrence')?.addEventListener('click', () => modaleRecurrence.classList.add('hidden'));
  document.getElementById('btn-annuler-recurrence')?.addEventListener('click', () => modaleRecurrence.classList.add('hidden'));

  // Actions du panier et de la finalisation
  ui.btnValiderPanier?.addEventListener('click', afficherConteneurFinalisation);
  document.getElementById('btn-envoyer-devis')?.addEventListener('click', gererDemandeDevis);
  ui.formulaireReservation?.addEventListener('submit', gererSoumissionReservation);
  ui.btnAnnulerReservation?.addEventListener('click', () => ui.conteneurFinalisation.classList.add('hidden'));
  ui.listePanier?.addEventListener('click', gererActionsPanier);

  // Écouteurs pour la modale de demande d'email pour le devis
  const modaleEmailDevis = document.getElementById('modale-email-devis');
  document.getElementById('formulaire-email-devis')?.addEventListener('submit', (e) => {
      e.preventDefault();
      const emailInput = document.getElementById('email-pour-devis');
      if (emailInput && emailInput.value) {
          envoyerDevis(emailInput.value.trim());
          modaleEmailDevis.classList.add('hidden');
          emailInput.value = '';
      }
  });
  document.getElementById('btn-fermer-email-devis')?.addEventListener('click', () => {
      modaleEmailDevis.classList.add('hidden');
  });

  // Gestion du client
  ui.champEmailClient?.addEventListener('blur', (e) => {
      if(e.target.value) {
          preRemplirInfosClient(e.target.value);
      }
  });
  ui.btnChangerClient?.addEventListener('click', reinitialiserClient);

  // Gestion du destinataire
  const interrupteurDestinataire = document.getElementById('interrupteur-destinataire');
  const formulaireDestinataire = document.getElementById('formulaire-destinataire');
  const nomDestinataireInput = document.getElementById('destinataire-nom');
  const adresseDestinataireInput = document.getElementById('destinataire-adresse');
  
  interrupteurDestinataire?.addEventListener('change', (e) => {
      const isChecked = e.target.checked;
      formulaireDestinataire.style.display = isChecked ? 'block' : 'none';
      nomDestinataireInput.required = isChecked;
      adresseDestinataireInput.required = isChecked;
  });
}

/**
 * Point d'entrée principal, exécuté après le chargement du DOM.
 */
document.addEventListener('DOMContentLoaded', () => {
  chargerPanierDepuisLocalStorage(); 
  verifierSessionClient(); 
  afficherCalendrier(window.etat.dateActuelle.getMonth() + 1, window.etat.dateActuelle.getFullYear());
  configurerEcouteursEvenements();
  initialiserLogiqueParrainage();
});

/**
 * Change le mois affiché dans le calendrier.
 * @param {number} delta - Le changement de mois (-1 pour précédent, 1 pour suivant).
 */
function changerMois(delta) {
    window.etat.dateActuelle.setMonth(window.etat.dateActuelle.getMonth() + delta);
    afficherCalendrier(window.etat.dateActuelle.getMonth() + 1, window.etat.dateActuelle.getFullYear());
}

/**
 * Récupère toutes les données du formulaire de réservation, y compris celles du destinataire.
 * @returns {Object} Un objet contenant les données de la réservation.
 */
function recupererDonneesFormulaire() {
    const estPourDestinataire = document.getElementById('interrupteur-destinataire').checked;
    let destinataireData = null;

    if (estPourDestinataire) {
        destinataireData = {
            nom: document.getElementById('destinataire-nom').value.trim(),
            adresse: document.getElementById('destinataire-adresse').value.trim(),
            email: document.getElementById('destinataire-email').value.trim(),
            facturerA: document.querySelector('input[name="facturation"]:checked').value
        };
    }

    return {
        client: {
            email: document.getElementById('client-email').value.trim(),
            nom: document.getElementById('client-nom').value.trim(),
            adresse: document.getElementById('client-adresse').value.trim(),
            siret: document.getElementById('client-siret').value.trim(),
            note: document.getElementById('note-reservation').value.trim()
        },
        items: window.etat.panier,
        codeParrainage: parrainageApplique.code,
        destinataire: destinataireData // Peut être null
    };
}
</script>





